import { Router } from 'express';
import axios from 'axios';
import { logger } from '../utils/logger.js';

const router = Router();

// Get recent CVEs
router.get('/cves', async (req, res) => {
  try {
    const { limit = 20, severity } = req.query;
    
    // Mock data - in production, fetch from NVD API
    const cves = [
      {
        id: 'CVE-2024-21762',
        description: 'FortiOS out-of-bound write vulnerability in SSL VPN',
        severity: 'critical',
        cvssScore: 9.8,
        publishedDate: '2024-02-20',
        affectedProducts: ['FortiOS 7.4.x', 'FortiOS 7.2.x', 'FortiOS 7.0.x'],
        exploitAvailable: true,
        cisaKEV: true
      },
      {
        id: 'CVE-2024-1234',
        description: 'Apache Log4j remote code execution',
        severity: 'critical',
        cvssScore: 9.0,
        publishedDate: '2024-02-18',
        affectedProducts: ['Log4j 2.x'],
        exploitAvailable: true,
        cisaKEV: true
      },
      {
        id: 'CVE-2024-0056',
        description: 'Microsoft Exchange Server elevation of privilege',
        severity: 'high',
        cvssScore: 8.1,
        publishedDate: '2024-02-15',
        affectedProducts: ['Exchange Server 2019', 'Exchange Server 2016'],
        exploitAvailable: false,
        cisaKEV: false
      }
    ];
    
    let filtered = cves;
    if (severity) {
      filtered = cves.filter(c => c.severity === severity);
    }
    
    res.json(filtered.slice(0, Number(limit)));
  } catch (error) {
    logger.error('Error fetching CVEs', error);
    res.status(500).json({ error: 'Failed to fetch CVEs' });
  }
});

// Get CVE details
router.get('/cves/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    // In production, fetch from NVD API
    const cve = {
      id,
      description: 'Detailed description of the vulnerability...',
      severity: 'critical',
      cvssScore: 9.8,
      cvssVector: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H',
      publishedDate: '2024-02-20',
      modifiedDate: '2024-02-25',
      affectedProducts: ['Product A', 'Product B'],
      references: [
        'https://nvd.nist.gov/vuln/detail/' + id,
        'https://cve.mitre.org/cgi-bin/cvename.cgi?name=' + id
      ],
      exploitAvailable: true,
      solution: 'Update to the latest version'
    };
    
    res.json(cve);
  } catch (error) {
    logger.error('Error fetching CVE details', error);
    res.status(500).json({ error: 'Failed to fetch CVE details' });
  }
});

// Start vulnerability scan
router.post('/scan', async (req, res) => {
  try {
    const { target, scanType = 'quick' } = req.body;
    
    if (!target) {
      return res.status(400).json({ error: 'Target is required' });
    }
    
    // In production, this would queue a scan job
    const scan = {
      id: `scan-${Date.now()}`,
      target,
      scanType,
      status: 'queued',
      progress: 0,
      startTime: new Date().toISOString(),
      estimatedDuration: scanType === 'full' ? '45 minutes' : '15 minutes'
    };
    
    res.status(201).json(scan);
  } catch (error) {
    logger.error('Error starting scan', error);
    res.status(500).json({ error: 'Failed to start scan' });
  }
});

// Get scan status
router.get('/scan/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    // Mock scan status
    const scan = {
      id,
      target: 'example.com',
      status: 'completed',
      progress: 100,
      startTime: new Date(Date.now() - 3600000).toISOString(),
      endTime: new Date().toISOString(),
      findings: [
        { id: '1', title: 'SQL Injection', severity: 'critical', cve: 'CVE-2024-1234' },
        { id: '2', title: 'XSS Reflected', severity: 'high' },
        { id: '3', title: 'Missing Headers', severity: 'low' }
      ]
    };
    
    res.json(scan);
  } catch (error) {
    logger.error('Error fetching scan status', error);
    res.status(500).json({ error: 'Failed to fetch scan status' });
  }
});

// Get all scans
router.get('/scans', async (req, res) => {
  try {
    const scans = [
      { id: '1', target: 'example.com', status: 'completed', progress: 100, findingsCount: 4 },
      { id: '2', target: '192.168.1.0/24', status: 'running', progress: 67, findingsCount: 0 },
      { id: '3', target: 'api.myservice.local', status: 'completed', progress: 100, findingsCount: 2 }
    ];
    
    res.json(scans);
  } catch (error) {
    logger.error('Error fetching scans', error);
    res.status(500).json({ error: 'Failed to fetch scans' });
  }
});

export { router as vulnerabilityRouter };
